var t;t=function(){"use strict";function t(t,e,r,a){return new(r||(r=Promise))((function(s,n){function o(t){try{c(a.next(t))}catch(t){n(t)}}function i(t){try{c(a.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,i)}c((a=a.apply(t,e||[])).next())}))}const e=t=>{const e=history[t];return function(){const r=e.apply(this,arguments),a=new Event(t);return window.dispatchEvent(a),r}};class r{constructor(t){this.data=Object.assign(this.initDef(),t),this.installTracker()}initDef(){return window.history.pushState=e("pushState"),window.history.replaceState=e("replaceState"),{historyTracker:!1,hashTracker:!1,domTracker:!1,jsError:!1,dataOnly:!1}}targetKeyReport(){if(this.data.element)for(const[t,e]of this.data.element)window.addEventListener(e,(r=>{const a=r.target.getAttribute(t);a&&this.reportTracker("dom",{event:e,targetKey:a,data:{code:10003,type:"dom",message:"用户操作记录 ",keyTarget:t,targetKey:a}})}))}captureEvents(t,e,r){t.forEach((t=>{window.addEventListener(t,(()=>{this.reportTracker(e,{event:t,targetKey:e,data:r,href:location.href})}))}))}captureOblyEvents(t,e,r){t.forEach((t=>{document.addEventListener(t,(a=>{if(a.target,a&&a.target&&a.target.getAttribute&&null!==a.target.getAttribute("data-chovrio")){console.log(a.target.getAttribute("data-chovrio"));const s=JSON.parse(a.target.getAttribute("data-chovrio").replace(/'/g,'"'));this.reportTracker(e,{event:t,targetKey:e,message:r,data:s})}}))}))}installTracker(){this.data.historyTracker&&this.captureEvents(["pushState","replaceState","popstate"],"history",{code:10001,type:"history",message:"用户浏览记录 "}),this.data.hashTracker&&this.captureEvents(["hashchange"],"hash",{code:10002,type:"hash-history",message:"用户浏览记录 "}),this.data.domTracker&&this.targetKeyReport(),this.data.jsError&&this.jsError(),this.data.dataOnly&&this.captureOblyEvents(["click"],"data-only",{code:10005,type:"data-only",message:"自定义事件 "})}errorEvent(){window.addEventListener("error",(t=>{this.reportTracker("error",{event:"error",targetKey:"同步错误",data:{code:10004,message:t.message}})}))}promiseReject(){window.addEventListener("unhandledrejection",(t=>{t.promise.catch((t=>{this.reportTracker("error",{event:"promise",targetKey:"异步错误",error:{code:10005,message:t.toString()}})}))}))}jsError(){this.errorEvent(),this.promiseReject()}reportTracker(t,e){const r=this.data.uuid,a=((t,e=!1)=>{const r=new Date(t),a=r.getFullYear(),s=r.getMonth()+1,n=r.getDate(),o=r.getHours()<10?"0"+r.getHours():r.getHours(),i=r.getMinutes()<10?"0"+r.getMinutes():r.getMinutes(),c=r.getSeconds()<10?"0"+r.getSeconds():r.getSeconds();return e?`${a}年${s}月${n}日 ${o}:${i}:${c}`:`${a}年${s}月${n}日`})((new Date).getTime(),!0),s=Object.assign({name:r,time:a},e);let n=new Blob([JSON.stringify(s)],{type:"application/x-www-form-urlencoded"});navigator.sendBeacon(this.data.requestUrl+t,n)}fetch(e,r="GET",a){return t(this,void 0,void 0,(function*(){const t=yield fetch(`${this.data.requestUrl}${e}`,{method:r,body:a?JSON.stringify(a):null});return yield t.json()}))}sendTracker(t,e){this.reportTracker(t,e)}setUser(t){this.data.uuid=t}setExtra(t){this.data.extra=t}}t(void 0,void 0,void 0,(function*(){let t=(t=>t.split("?")[1].split("&").reduce(((t,e)=>{const r=e.split("=");return t[r[0]]=r[1],t}),{}))(document.querySelectorAll("script")[0].src);if(void 0===t.name)console.warn("身份认证失败，无法进行埋点");else{const e=yield fetch(`http://localhost:4000/user/${t.name}`);"200"===(yield e.text())?new r({uuid:t.name,requestUrl:"http://localhost:4000/",historyTracker:!0,jsError:!0,dataOnly:!!t.only&&1===parseInt(t.only)}):console.warn("身份认证失败，无法进行埋点")}}))},"function"==typeof define&&define.amd?define(t):t();
